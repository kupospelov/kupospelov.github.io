<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Accessing a machine behind NAT - Konstantin Pospelov</title><link rel=stylesheet href=/style.css type=text/css media=all><link rel=stylesheet href=/syntax-light.css type=text/css media="screen and (prefers-color-scheme: light)"><link rel=stylesheet href=/syntax-dark.css type=text/css media="screen and (prefers-color-scheme: dark)"><link rel=icon type=image/jpg href=/img/me.jpg></head><body><nav class=menu><a class=menu-item href=/>about</a>
<a class="menu-item current" href=/blog/>blog</a><hr></nav><main><article><time pubdate=pubdate>Oct 31, 2021</time><h1>Accessing a machine behind NAT</h1><p>I have a remote machine that I have to occasionally maintain. There is no easy way to connect to it, since all available ISPs at that place can only offer IPv4 (which nowadays means NAT) and not IPv6.</p><p>For this purpose I chose WireGuard, which is probably the simplest and fastest VPN solution available today. There is a great number of articles on this topic on the web. I mostly followed <a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04>this one</a>, but used other available sources as well.</p><h2 id=base-setup>Base setup</h2><p>Generate private and public keys for each peer using <code>wg genkey</code> and <code>wg pubkey</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>wg genkey <span class=p>|</span> tee private.key <span class=p>|</span> wg pubkey &gt; public.key
</span></span></code></pre></div><p>Configure <code>/etc/wireguard/wg0.conf</code> on the server. Well, in the WireGuard world all machines are just &ldquo;peers&rdquo;, however let&rsquo;s call the machine with a public IP a &ldquo;server&rdquo; for brevity. I use this as a template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>$PRIVATE_KEY # The server private key</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.8.0.1</span>
</span></span><span class=line><span class=cl><span class=na>ListenPort</span> <span class=o>=</span> <span class=s>$PORT</span>
</span></span><span class=line><span class=cl><span class=na>SaveConfig</span> <span class=o>=</span> <span class=s>true</span>
</span></span></code></pre></div><p>Configure <code>/etc/wireguard/wg0.conf</code> on other peers that connect to our server. I use this as a template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>$PRIVATE_KEY # The current peer private key</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.8.0.$NUMBER/24</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>$PUBLIC_KEY # The server public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.8.0.0/24</span>
</span></span><span class=line><span class=cl><span class=na>PersistentKeepalive</span> <span class=o>=</span> <span class=s>25</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>$ADDRESS:$PORT</span>
</span></span></code></pre></div><p>Note that I set <a href=https://www.wireguard.com/quickstart/#nat-and-firewall-traversal-persistence>PersistentKeepalive</a>, without this settings you might not be able to access machines behind NAT after some time.</p><p>Add a new <code>[Peer]</code> section to your server config:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>$PUBLIC_KEY # The public key of the new peer</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.8.0.$NUMBER/32</span>
</span></span></code></pre></div><p>That is it! You can bring up the interface using <code>wg-quick up wg0</code> on both ends. You can also use <code>wg-quick@wg0.service</code> to start the tunnel automatically using systemd.</p><h2 id=forwarding>Forwarding</h2><p>In order to allow the peers to communicate with each other we also need to enable packet forwarding.</p><p>Set the following variables in <code>/etc/sysctl.conf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>net.ipv4.ip_forward</span> <span class=o>=</span> <span class=s>1</span>
</span></span></code></pre></div><p>Enable forwarding on wg0:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>iptables -A FORWARD -i wg0 -o wg0 -j ACCEPT
</span></span></code></pre></div><h2 id=masquerading-optional>Masquerading (optional)</h2><p>If you also want to route external traffic through the server, enable packet forwarding and masquerading on the external interface:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>iptables -A FORWARD -i wg0 -o <span class=nv>$INTERFACE</span> -j ACCEPT
</span></span><span class=line><span class=cl>iptables -t nat -I POSTROUTING -o <span class=nv>$INTERFACE</span> -j MASQUERADE
</span></span></code></pre></div><p>In this case also make sure to update <code>AllowedIPs</code> to <code>0.0.0.0/0</code> on the peers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>$PUBLIC_KEY</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>0.0.0.0/0</span>
</span></span><span class=line><span class=cl><span class=na>PersistentKeepalive</span> <span class=o>=</span> <span class=s>25</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>$ADDRESS:$PORT</span>
</span></span></code></pre></div><p>At this point you should have a working setup that allows peers to send packets to each other and (optionally) even route your external traffic through the server. Have fun using WireGuard!</p></article></main><footer><hr><p>The content is licensed under <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a>.</p><br></footer></body></html>